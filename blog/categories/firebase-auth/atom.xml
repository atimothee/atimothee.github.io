<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: firebase-auth | Timothy Asiimwe]]></title>
  <link href="http://atimothee.github.io/blog/categories/firebase-auth/atom.xml" rel="self"/>
  <link href="http://atimothee.github.io/"/>
  <updated>2016-10-22T00:28:29+03:00</updated>
  <id>http://atimothee.github.io/</id>
  <author>
    <name><![CDATA[Timothy Asiimwe]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[How to use Facebook Account Kit to authenticate Firebase app users on Android]]></title>
    <link href="http://atimothee.github.io/blog/2016/09/17/how-to-use-facebook-account-kit-to-authenticate-firebase-app-users-on-android/"/>
    <updated>2016-09-17T15:53:28+03:00</updated>
    <id>http://atimothee.github.io/blog/2016/09/17/how-to-use-facebook-account-kit-to-authenticate-firebase-app-users-on-android</id>
    <content type="html"><![CDATA[<p>A few months ago Facebook released <a href="https://developers.facebook.com/docs/accountkit/overview">Account Kit</a> which &ldquo;helps people quickly and easily register and log into your app using their phone number or email address as a passwordless credential&rdquo;.</p>

<p>Account Kit is really really helpful for a couple of reasons; users don&rsquo;t need to remember a password for your app, it supports SMS-based authentication for hundreds of countries, and it&rsquo;s really easy to setup.</p>

<!-- more -->


<p><a href="https://firebase.google.com/">The Firebase platform</a> provides a number of tools like <a href="https://firebase.google.com/docs/auth/">Firebase Authentication</a> which remove alot of the friction involved in building high quality apps. Using Firebase Authentication, you can easily integrate Facebook, Twitter, and Google Login in your Android app.</p>

<p>Unfortunately, the Firebase Authentication SDK does not currently provide a direct way to authenticate users with Facebook Account Kit, however, this can be achieved using <a href="https://firebase.google.com/docs/auth/android/custom-auth">Firebase Custom Authentication</a>. This tutorial will show you how. Firebase Custom authentication allow users to authenticate against an external or legacy authentication mechanism. We will treat Facebook Account Kit as a legacy authentication mechanism.</p>

<p>This tutorials assumes you&rsquo;ve already configured your android project to use Firebase Authentication. If you haven&rsquo;t yet, you can follow the instructions <a href="https://firebase.google.com/docs/android/setup">here</a>.
I also assume you&rsquo;ve already set up your app to use Facebook Account Kit. You can follow set up instructions <a href="https://developers.facebook.com/docs/accountkit/android">here</a>.</p>

<h2>Server setup</h2>

<p>To use Custom Authentication, we need to setup an authentication server, which creates custom tokens, which can then be used sign into the Firebase Authentication service in the android app.
Firebase only has Server SDKs for Java and NodeJS (at the moment), so you need to build your authentication server using one of the 2 languages. We will use Java for this tutorial, and we&rsquo;ll use <a href="https://cloud.google.com/appengine/docs/java/endpoints/">Google Appengine Cloud endpoints</a>, as our hosting solution, for simplicity (because all the code can live inside Android Studio).</p>

<p>You should be able to follow this tutorial without in-depth knowledge of how Google Cloud endpoints work. If you want a basic understanding of how they work, you can start <a href="https://cloud.google.com/appengine/docs/java/endpoints/helloendpoints-android-studio">here</a>.</p>

<p>Adding Cloud Endpoints to an Android Studio project is trivial. Go to File > New > New Module &hellip; and select Google Cloud Module as shown in screenshots below.</p>

<p><img src="/images/android_studio_new_module_screenshot.png"></p>

<p><img src="/images/new_google_cloud_module_screenshot.png"></p>

<p>Once your project&rsquo;s done building, you should have a new module/directory called backend, or whatever you named your Google cloud module.</p>

<p>Next, you need to add Firebase Server SDK and <a href="http://square.github.io/retrofit/">Retrofit</a> to the build.gradle for the backend module as shown below.
We will be using Retrofit to make a call to the <a href="https://developers.facebook.com/docs/accountkit/graphapi">AccountsKit Graph API</a> to access the user&rsquo;s basic information and save to Firebase, and also use it to create a custom token.
<strong>Please note that you must not use retrofit v2 or higher (if you&rsquo;re using Cloud endpoints), because it&rsquo;s not compatible with appengine runtime environment.</strong></p>

<p><div class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="n">compile</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="o">;</span><span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">retrofit</span><span class="o">:</span><span class="nl">retrofit:</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="o">;</span>
<span class="n">compile</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="o">;</span><span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">ok</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"http:okhttp:2.7.2"</span><span class="o">&gt;</span><span class="nl">http:okhttp:</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">2</span><span class="o">&lt;</span><span class="s">/a&gt;&amp;rsquo;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">compile</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="o">;</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">firebase</span><span class="o">:</span><span class="n">firebase</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="nl">sdk:</span><span class="o">[</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">0</span><span class="o">,)&amp;</span><span class="n">rsquo</span><span class="o">;</span></code></pre></div></p>

<p>First, we need to create the Bean that will return the custom token to the user.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomTokenBean</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">token</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setData</span><span class="o">(</span><span class="n">String</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">String</span> <span class="nf">getData</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">token</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span></code></pre></div></p>

<p>Next, we will use retrofit to retrieve the user&rsquo;s details, using the Account Kit access token.</p>

<p>Here&rsquo;s the class that matches the JSON returned by the AccountsKit Graph API. We will use it as the return type for the retrofit function.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountsKitUser</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="nf">AccountsKitUser</span><span class="o">(){</span>

<span class="o">}</span>

<span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
<span class="kd">private</span> <span class="n">Phone</span> <span class="n">phone</span><span class="o">;</span>

<span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">Phone</span> <span class="nf">getPhone</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">phone</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPhone</span><span class="o">(</span><span class="n">Phone</span> <span class="n">phone</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">Phone</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Phone</span><span class="o">(){</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">number</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">countryPrefix</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nationalNumber</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">number</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNumber</span><span class="o">(</span><span class="n">String</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">number</span> <span class="o">=</span> <span class="n">number</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCountryPrefix</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">countryPrefix</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCountryPrefix</span><span class="o">(</span><span class="n">String</span> <span class="n">countryPrefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">countryPrefix</span> <span class="o">=</span> <span class="n">countryPrefix</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNationalNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">nationalNumber</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNationalNumber</span><span class="o">(</span><span class="n">String</span> <span class="n">nationalNumber</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">nationalNumber</span> <span class="o">=</span> <span class="n">nationalNumber</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span></code></pre></div></p>

<p>Here&rsquo;s the retrofit adapter and interface that retrieves the user information.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">API_BASE_URL</span> <span class="o">=</span> <span class="s">"https://graph.accountkit.com"</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">RestAdapter</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RestAdapter</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setEndpoint</span><span class="o">(</span><span class="n">API_BASE_URL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setClient</span><span class="o">(</span><span class="k">new</span> <span class="n">UrlFetchClient</span><span class="o">());</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">S</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">S</span> <span class="nf">createService</span><span class="o">(</span><span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">S</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">serviceClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RestAdapter</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">adapter</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">serviceClass</span><span class="o">);</span>
<span class="o">}</span>


<span class="kd">public</span>  <span class="kd">interface</span> <span class="nc">GetUserDetailsService</span><span class="o">{</span>
    <span class="nd">@GET</span><span class="o">(</span><span class="s">"/v1.0/me"</span><span class="o">)</span>
    <span class="n">AccountsKitUser</span> <span class="nf">getUserDetails</span><span class="o">(</span><span class="nd">@Query</span><span class="o">(</span><span class="s">"access_token"</span><span class="o">)</span> <span class="n">String</span> <span class="n">accessToken</span><span class="o">);</span>

<span class="o">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>Once we have the user id, we can then use the Firebase SDK to create a custom token.</p>

<p>In order to communicate with the Firebase service, you will need a service account, and configuration file with your service account credentials. Follow the instructions <a href="https://firebase.google.com/docs/server/setup">here</a> to obtain a JSON configuration file and add it to your backend module (under the WEB-INF folder).</p>

<p>Next, you need to add the json file as a resource to the appengine-web.xml to allow read access to the service account json file. The appengine-web.xml file is located in the WEB-INF folder. If you cannot see this folder, you may need to switch to the project view in Android Studio.</p>

<p><div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>?xml version=<span class="ni">&amp;ldquo;</span>1.0<span class="ni">&amp;rdquo;</span> encoding=<span class="ni">&amp;ldquo;</span>utf-8<span class="ni">&amp;rdquo;</span>?&gt;
<span class="nt">&lt;appengine-web-app</span> <span class="na">xmlns=</span><span class="s">"http://appengine.google.com/ns/1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;application&gt;</span>project-id<span class="nt">&lt;/application&gt;</span>
    <span class="nt">&lt;version&gt;</span>1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;module&gt;</span>backend<span class="nt">&lt;/module&gt;</span>
    <span class="nt">&lt;threadsafe&gt;</span>true<span class="nt">&lt;/threadsafe&gt;&lt;/p&gt;</span>

<span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>system-properties<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>property name="java.util.logging.config.file" value="WEB-INF/logging.properties"/<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/system-properties<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>resource-files<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>include path="/**.json" /<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/resource-files<span class="ni">&amp;gt;</span>
<span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>

<span class="nt">&lt;p&gt;&lt;/appengine-web-app&gt;</span></code></pre></div></p>

<p><strong>Please note that the json configuration file must be in the WEB-INF folder, otherwise it will not be accessible in code.</strong></p>

<p>Since Firebase, is now part of Google Cloud Platform, <strong>a Firebase project == a Google Cloud project</strong>, and therfore can access other Google Cloud APIs and services, therefore you can use your firebase-project-id as the project-id in the appengine-web.xml.
Alternatively, you could create a new Google cloud project, and specify the application name. (Please note: Appengine has a free quota, and you should be able to signup without needing a credit card.)</p>

<p>We then create an endpoint, that creates and returns the custom token to the user. You can use the users phone number or the their id as the uid (depending on your app&rsquo;s requirements).</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@ApiMethod</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">getCustomToken</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)</span>
    <span class="kd">public</span> <span class="n">CustomTokenBean</span> <span class="nf">getCustomToken</span><span class="o">(</span><span class="nd">@Named</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">access_token</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)</span> <span class="n">String</span> <span class="n">accessToken</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">FileNotFoundException</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="n">GetUserDetailsService</span> <span class="n">getUserDetailsService</span> <span class="o">=</span> <span class="n">createService</span><span class="o">(</span><span class="n">GetUserDetailsService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">AccountsKitUser</span> <span class="n">retrofitResponse</span> <span class="o">=</span> <span class="n">getUserDetailsService</span><span class="o">.</span><span class="na">getUserDetails</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">retrofitResponse</span><span class="o">.</span><span class="na">getPhone</span><span class="o">().</span><span class="na">getNumber</span><span class="o">();</span>
    <span class="n">FirebaseOptions</span> <span class="n">options</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FirebaseOptions</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setServiceAccount</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"WEB-INF/json_file_name.json"</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">setDatabaseUrl</span><span class="o">(</span><span class="s">"https://firebase-project-id.firebaseio.com/"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="n">FirebaseApp</span><span class="o">.</span><span class="na">initializeApp</span><span class="o">(</span><span class="n">options</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">customToken</span> <span class="o">=</span> <span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">createCustomToken</span><span class="o">(</span><span class="n">uid</span><span class="o">);</span>

    <span class="n">CustomTokenBean</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomTokenBean</span><span class="o">();</span>
    <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">customToken</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>Next, you need to deploy the backend module to appengine, in order to be able to use it. To do this, go to Build> Deploy Module to Appengine&hellip; and login with your google account.</p>

<h2>Now, for the Android part&hellip;</h2>

<p>In your sign-in activity&rsquo;s onCreate method, get the shared instance of the FirebaseAuth object:
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">FirebaseAuth</span> <span class="n">mAuth</span><span class="o">;</span>
<span class="c1">// &amp;hellip;</span>
<span class="n">mAuth</span> <span class="o">=</span> <span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span></code></pre></div></p>

<p>Create an AsyncTask which sends an AccountKit token, to the authentication server, receives the custom token from the authenticaiton server, and then signs in the user into Firebase using the custom token:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">LoginUserAsyncTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="c1">//uses returned custom token to login to Firebase</span>
        <span class="n">mAuth</span><span class="o">.</span><span class="na">signInWithCustomToken</span><span class="o">(</span><span class="n">token</span><span class="o">).</span><span class="na">addOnCompleteListener</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="k">new</span> <span class="n">OnCompleteListener</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">AuthResult</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Task</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">AuthResult</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">// If sign in fails, display a message to the user. If sign in succeeds</span>
                <span class="c1">// the auth state listener will be notified and logic to handle the</span>
                <span class="c1">// signed in user can be handled in the listener.</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">isSuccessful</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"Authentication failed."</span><span class="o">,</span>
                            <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">strings</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">//sends AccountKit token to authentication server</span>
        <span class="n">String</span> <span class="n">accountsKitAccessToken</span> <span class="o">=</span> <span class="n">strings</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="n">MyApi</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyApi</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">AndroidHttp</span><span class="o">.</span><span class="na">newCompatibleTransport</span><span class="o">(),</span> <span class="k">new</span> <span class="n">AndroidJsonFactory</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setRootUrl</span><span class="o">(</span><span class="s">"https://backend-dot-fb-accountkit-auth-demo.appspot.com/_ah/api"</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setApplicationName</span><span class="o">(</span><span class="s">"fb-accountkit-auth-demo"</span><span class="o">);</span>
        <span class="n">MyApi</span> <span class="n">service</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">CustomTokenBean</span> <span class="n">customTokenBean</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getCustomToken</span><span class="o">(</span><span class="n">accountsKitAccessToken</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">customTokenBean</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>


        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>At the point where you initiate the user login via AccountsKit. You must set the responseType to TOKEN, so that an access token is returned to the calling activity once the login process is complete.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLoginPhone</span><span class="o">(</span><span class="kd">final</span> <span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">AccountKitActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">AccountKitConfiguration</span><span class="o">.</span><span class="na">AccountKitConfigurationBuilder</span> <span class="n">configurationBuilder</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">AccountKitConfiguration</span><span class="o">.</span><span class="na">AccountKitConfigurationBuilder</span><span class="o">(</span>
                        <span class="n">LoginType</span><span class="o">.</span><span class="na">PHONE</span><span class="o">,</span>
                        <span class="n">AccountKitActivity</span><span class="o">.</span><span class="na">ResponseType</span><span class="o">.</span><span class="na">TOKEN</span><span class="o">);</span> <span class="c1">// you must use TOKEN response type</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span>
                <span class="n">AccountKitActivity</span><span class="o">.</span><span class="na">ACCOUNT_KIT_ACTIVITY_CONFIGURATION</span><span class="o">,</span>
                <span class="n">configurationBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">startActivityForResult</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">APP_REQUEST_CODE</span><span class="o">);</span>
    <span class="o">}</span></code></pre></div></p>

<p><strong>Please note that to be able to use the TOKEN response type, you must enable client access token flow in the Facebook developer console, as shown in the screenshot below.</strong></p>

<p><img src="/images/facebook_console_screenshot.png"></p>

<p>Next, you need to adapt the onActivityResult method in the Activity that initates the Account Kit login, to execute the LoginUserAsyncTask, once the accountkit user access token is obtained.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span>
            <span class="kd">final</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="n">APP_REQUEST_CODE</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// confirm that this response matches your request</span>
            <span class="n">AccountKitLoginResult</span> <span class="n">loginResult</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">AccountKitLoginResult</span><span class="o">.</span><span class="na">RESULT_KEY</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">toastMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">loginResult</span><span class="o">.</span><span class="na">getError</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">toastMessage</span> <span class="o">=</span> <span class="n">loginResult</span><span class="o">.</span><span class="na">getError</span><span class="o">().</span><span class="na">getErrorType</span><span class="o">().</span><span class="na">getMessage</span><span class="o">();</span>
                <span class="c1">//showErrorActivity(loginResult.getError());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">loginResult</span><span class="o">.</span><span class="na">wasCancelled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">toastMessage</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">Login</span> <span class="n">Cancelled</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">loginResult</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>                <span class="n">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">loginResult</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">().</span><span class="na">getToken</span><span class="o">();</span>

                <span class="k">new</span> <span class="nf">LoginUserAsyncTask</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>

                <span class="n">toastMessage</span> <span class="o">=</span> <span class="s">"Success:"</span> <span class="o">+</span> <span class="n">loginResult</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">().</span><span class="na">getAccountId</span><span class="o">();</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">toastMessage</span> <span class="o">=</span> <span class="s">"Login failed"</span><span class="o">;</span>
            <span class="o">}</span>

        <span class="o">}</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span>
                <span class="k">this</span><span class="o">,</span>
                <span class="n">toastMessage</span><span class="o">,</span>
                <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">)</span>
                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>Finally, you need to setup an AuthStateListener that responds to changes in the user&rsquo;s sign-in state:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">AuthStateListener</span> <span class="n">mAuthListener</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c1">// &amp;hellip;&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// &amp;hellip;</span>
    <span class="n">mAuthListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">AuthStateListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthStateChanged</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">FirebaseAuth</span> <span class="n">firebaseAuth</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">FirebaseUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">firebaseAuth</span><span class="o">.</span><span class="na">getCurrentUser</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// User is signed into Firebase&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// User is signed out of Firebase</span>
                <span class="c1">// Check if user is still signed into FB AccountKit</span>
                <span class="n">AccessToken</span> <span class="n">accountKitAccessToken</span> <span class="o">=</span> <span class="n">AccountKit</span><span class="o">.</span><span class="na">getCurrentAccessToken</span><span class="o">();</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">accountKitAccessToken</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">//user is already logged into FB AccountKit, skip login, and try to authenticate Firebase</span>
                    <span class="k">new</span> <span class="nf">LoginUserAsyncTask</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">accountKitAccessToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
                    <span class="n">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">LoggedInActivity</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>


                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">//Handle new or logged out user</span>
                <span class="o">}</span>

            <span class="o">}</span>
            <span class="c1">// ...</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="c1">// ...</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
    <span class="n">mAuth</span><span class="o">.</span><span class="na">addAuthStateListener</span><span class="o">(</span><span class="n">mAuthListener</span><span class="o">);</span>
    <span class="c1">// &amp;hellip;</span>
<span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onStop</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mAuthListener</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mAuth</span><span class="o">.</span><span class="na">removeAuthStateListener</span><span class="o">(</span><span class="n">mAuthListener</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// &amp;hellip;</span>
<span class="o">}</span></code></pre></div></p>

<p>In this post, we looked at how to authenticate Firebase app users using Facebook AccountKit. The code is available on <a href="https://github.com/atimothee/accountkit-firebase-auth-android">Github</a>. The best way to utilize this post is to clone the app, import it into Android Studio and play with the code yourself using this post as a guide.</p>

<p>It should be possible to write your authentication server in NodeJS, or any other Java framework, and run it wherever you like. You can read more <a href="https://firebase.google.com/docs/auth/server/">here</a> on how to implement custom authentication.</p>

<p>Got any questions? Ping me on Twitter: <a href="https://twitter.com/TimAsiimwe">@TimAsiimwe</a>, Iâ€™d be happy to chat!</p>

<h4>References:</h4>

<p><a href="https://github.com/square/retrofit/issues/1149">https://github.com/square/retrofit/issues/1149</a>
<a href="http://stackoverflow.com/questions/31507370/reading-java-resource-files-in-google-appengine">http://stackoverflow.com/questions/31507370/reading-java-resource-files-in-google-appengine</a>
<a href="https://firebase.google.com/docs/auth/android/custom-auth">https://firebase.google.com/docs/auth/android/custom-auth</a></p>
]]></content>
  </entry>
  
</feed>
